name: Render Documentation

# è§¦å‘æ¡ä»¶ï¼šæ–° tag æ¨é€
on:
  push:
    tags:
      - 'v*'  # åŒ¹é… v1.0.0, v2.1.3 ç­‰ç‰ˆæœ¬æ ‡ç­¾
      - '*'   # æˆ–åŒ¹é…æ‰€æœ‰ tag

jobs:
  render:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm install gray-matter@4.0.3
          npm install remark@15.0.1
          npm install remark-gfm@4.0.0
          npm install remark-parse@11.0.0
          npm install remark-rehype@11.1.1
          npm install rehype-prism-plus@2.0.0
          npm install rehype-sanitize@6.0.0
          npm install rehype-stringify@10.0.1
          npm install unified@11.0.5
      
      - name: Render Markdown to JSON
        run: node .github/scripts/render.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get tag name
        id: tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Commit rendered files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # åˆ›å»ºåˆ†æ”¯å­˜å‚¨æ¸²æŸ“ç»“æœ
          git checkout -b rendered/${{ steps.tag.outputs.TAG_NAME }}
          
          # æ·»åŠ æ¸²æŸ“æ–‡ä»¶
          git add rendered/
          
          # æäº¤
          git commit -m "ğŸš€ Render docs for tag ${{ steps.tag.outputs.TAG_NAME }}"
          
          # æ¨é€åˆ°è¿œç¨‹
          git push origin rendered/${{ steps.tag.outputs.TAG_NAME }}
      
      - name: Create or update latest branch
        run: |
          # ä¹Ÿæ›´æ–° rendered/latest åˆ†æ”¯æŒ‡å‘æœ€æ–°ç‰ˆæœ¬
          git branch -f rendered/latest
          git push origin rendered/latest --force
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rendered-docs-${{ steps.tag.outputs.TAG_NAME }}
          path: rendered/
          retention-days: 30

      - name: Notify completion
        run: |
          echo "âœ… Documentation rendered successfully!"
          echo "ğŸ“¦ Tag: ${{ steps.tag.outputs.TAG_NAME }}"
          echo "ğŸŒ¿ Branch: rendered/${{ steps.tag.outputs.TAG_NAME }}"
          echo "ğŸ“Š Files: $(find rendered -name '*.json' | wc -l) JSON files"
